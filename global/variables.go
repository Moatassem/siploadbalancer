package global

import (
	"regexp"
	"siploadbalancer/cl"
	"siploadbalancer/prometheus"
	"sync"
)

const (
	BUE            string = "SipLoadBalancer/v1.0"
	DeltaRune      rune   = 'a' - 'A'
	MagicCookie    string = "z9hG4bK"
	ViaHeader      string = "Via"
	SipVersion     string = "SIP/2.0"
	ProbingTimeout int    = 3
)

var (
	CallLimiter *cl.CallLimiter
	Prometrics  *prometheus.Metrics
	WtGrp       sync.WaitGroup
)

var (
	DicFieldRegEx = map[FieldPattern]*regexp.Regexp{
		RequestStartLinePattern:  regexp.MustCompile(`(?i)^\s*([a-z]+)\s+((?:\w+):(?:(?:[^@]+)@)?(?:[^@]+))\s+(SIP/2\.0)$`),
		INVITERURI:               regexp.MustCompile(`(?i)([a-z]+):(?:([\*\#\+]?[a-z0-9\.\-\(\)]+)((?:[,;](?:[\w\-]+=[^@=,;:]+|[\w\-]+))*)(:[^@]+)?@)?([^\*\#\+@,:;]+)(?::(\d+))?((?:[,;](?:[\w\-]+=[^@,;\?]+|[\w\-]+))*)(?:(\?[^?]+))*`),
		ResponseStartLinePattern: regexp.MustCompile(`(?i)^\s*(SIP/2\.0)\s+(\d{3})(?:\s+([^,;]+)([,;].+)?)?$`),
		ViaBranchPattern:         regexp.MustCompile(`(?i);branch\s*=\s*([^;,]+)`),
		FullHeader:               regexp.MustCompile(`(?i)^\s*([^:]+)\s*:\s*(.+)$`),
		ViaIPv4Socket:            regexp.MustCompile(`(?i)\s*SIP/2\.0\/(\w+)\s+((?:\d{1,3}\.){3}\d{1,3})(:\d+)?\s*`),
		IP6:                      regexp.MustCompile(`(?i)((?:(?:(?:(?:(?:(?:(?:[0-9a-f]{1,4})):){6})(?:(?:(?:(?:(?:[0-9a-f]{1,4})):(?:(?:[0-9a-f]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:::(?:(?:(?:[0-9a-f]{1,4})):){5})(?:(?:(?:(?:(?:[0-9a-f]{1,4})):(?:(?:[0-9a-f]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:[0-9a-f]{1,4})))?::(?:(?:(?:[0-9a-f]{1,4})):){4})(?:(?:(?:(?:(?:[0-9a-f]{1,4})):(?:(?:[0-9a-f]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-f]{1,4})):){0,1}(?:(?:[0-9a-f]{1,4})))?::(?:(?:(?:[0-9a-f]{1,4})):){3})(?:(?:(?:(?:(?:[0-9a-f]{1,4})):(?:(?:[0-9a-f]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-f]{1,4})):){0,2}(?:(?:[0-9a-f]{1,4})))?::(?:(?:(?:[0-9a-f]{1,4})):){2})(?:(?:(?:(?:(?:[0-9a-f]{1,4})):(?:(?:[0-9a-f]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-f]{1,4})):){0,3}(?:(?:[0-9a-f]{1,4})))?::(?:(?:[0-9a-f]{1,4})):)(?:(?:(?:(?:(?:[0-9a-f]{1,4})):(?:(?:[0-9a-f]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-f]{1,4})):){0,4}(?:(?:[0-9a-f]{1,4})))?::)(?:(?:(?:(?:(?:[0-9a-f]{1,4})):(?:(?:[0-9a-f]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-f]{1,4})):){0,5}(?:(?:[0-9a-f]{1,4})))?::)(?:(?:[0-9a-f]{1,4})))|(?:(?:(?:(?:(?:(?:[0-9a-f]{1,4})):){0,6}(?:(?:[0-9a-f]{1,4})))?::)))))\s*$`),
		IP4:                      regexp.MustCompile(`(?i)((?:(?:2(?:5[0-5]|[0-4]\d)|1?\d?\d)\.){3}(?:2(?:5[0-5]|[0-4]\d)|1?\d?\d))\s*$`),
		URIFull:                  regexp.MustCompile(`(?i)((?:sip|sips|tel):[^>]+)`),
		URIParameters:            regexp.MustCompile(`(?i)^(?:[,;](?:[\w\-]+|[\w\-]+=[^@=,;]+))*$`),
		URIParameter:             regexp.MustCompile(`(?i)^([^=]+)=([^=]+)$`),
		ErrorStack:               regexp.MustCompile(`(?i)(\w+\.vb):line\s(\d+)`),
		Tag:                      regexp.MustCompile(`(?i);tag=([^;]+)`),
	}
)
